<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>MobiFone ƒê·∫Øk L·∫Øk - MobiFiber</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- =========================
       TH∆Ø VI·ªÜN B·∫¢N ƒê·ªí LEAFLET
       ========================= -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- =========================
       GOOGLE VISUALIZATION
       D√πng ƒë·ªÉ ƒë·ªçc d·ªØ li·ªáu Google Sheet
       ========================= -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- =========================
       SHEETJS
       D√πng export Excel cho k·ªπ thu·∫≠t
       ========================= -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* =========================
       STYLE C∆† B·∫¢N CHO MAP
       ========================= */
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }

    /* =========================
       KHUNG ƒêI·ªÄU KHI·ªÇN (SEARCH + FILTER)
       ========================= */
    .control-box {
      position: absolute;
      top: 40px;  
      left: 5px;
      z-index: 1000;
      background: white;
      padding: 10px 12px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      font-size: 13px;
      min-width: 240px;
    }

    .panel-title {
      font-weight: bold;
      margin-bottom: 6px;
    }

    /* H√†ng nh·∫≠p t√¨m ki·∫øm */
    .search-row {
      display: flex;
      gap: 4px;
      margin-bottom: 6px;
    }

    .search-row input { flex: 1; }

    /* =========================
       LEGEND HI·ªÜU SU·∫§T
       ========================= */
    .legend {
      margin-top: 6px;
      border-top: 1px solid #eee;
      padding-top: 6px;
    }

    .legend div { margin-bottom: 4px; }

    /* =========================
       HI·ªÜU ·ª®NG NH·∫§P NH√ÅY
       D√πng highlight t·∫≠p ƒëi·ªÉm g·ª£i √Ω
       ========================= */
    .blink {
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    /* =========================
       KHUNG CH√ö GI·∫¢I HI·ªÜU SU·∫§T (G√ìC PH·∫¢I)
       ========================= */
    .hieusuat {
      position: fixed;
      right: 10px;
      bottom: 10px;
      z-index: 1000;
      background: white;
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      font-size: 13px;
    }

    .col {
      display: inline-block;
      width: 90px;
    }

    /* =========================
       G·ª¢I √ù ƒê·ªäA CH·ªà (AUTOCOMPLETE)
       ========================= */
    .suggest-box {
      position: absolute;
      top: 34px;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      max-height: 180px;
      overflow-y: auto;
      z-index: 2000;
      display: none;
      font-size: 12px;
    }
    
    .suggest-item {
      padding: 6px 8px;
      cursor: pointer;
    }
    
    .suggest-item:hover {
      background: #f0f0f0;
    }

    /* =========================
       N√öT ƒê·ªäNH V·ªä NG∆Ø·ªúI D√ôNG
       ========================= */
    .locate-btn {
      position: fixed;
      right: 10px;
      top: 10px;         
      z-index: 1001;
      background: white;
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }
    
    .locate-btn:hover {
      background: #f0f0f0;
    }

    /* =========================
       THU G·ªåN / M·ªû R·ªòNG CONTROL BOX
       ========================= */
    .control-box.collapsed {
      height: 42px;
      overflow: hidden;
      padding-bottom: 4px;
    }
    
    .control-box.collapsed .search-row,
    .control-box.collapsed select,
    .control-box.collapsed button,
    .control-box.collapsed .legend,
    .control-box.collapsed > div:not(.panel-title) {
      display: none;
    }

      /* =========================
       FILTER HI·ªÜU SU·∫§T THU G·ªåN
       ========================= */
    .filter-box {
      margin-top: 6px;
    }
    
    .filter-title {
      cursor: pointer;
      user-select: none;
    }
    
    .filter-content {
      margin-top: 6px;
      display: none; /* M·∫∂C ƒê·ªäNH ·∫®N */
    }

    /* =========================
       LOGO TR√äN CONTROL BOX
       ========================= */
    .branding {
      position: absolute;
      top: 5px;
      left: 5px;
      z-index: 1001;
    
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: bold;
      color: #0056a3;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
    
      pointer-events: none;
    }

    /* =========================
       CHI·ªÄU R·ªòNG POPUP LEAFLET
       ========================= */
    .leaflet-popup-content {
      min-width: 350px;
      max-width: min(500px, 90vw);
      font-size: 13px;
    }

  </style>
</head>

<body>

<!-- =========================
     KHUNG ƒêI·ªÄU KHI·ªÇN CH√çNH
     ========================= -->
<div class="control-box" id="controlBox">
  <div class="panel-title">
    T√¨m t·∫≠p ƒëi·ªÉm xung quanh kh√°ch h√†ng
    <!-- N√∫t thu g·ªçn / m·ªü r·ªông -->
    <span id="arrow" onclick="toggleControl()" style="float:right; cursor:pointer">‚ñ≤</span>
  </div>

    <!-- √î nh·∫≠p v·ªã tr√≠ kh√°ch h√†ng: g√µ t·ªça ƒë·ªô / ƒë·ªãa ch·ªâ ho·∫∑c t·ª± ƒë·ªông fill khi double-click tr√™n b·∫£n ƒë·ªì -->
    <div class="search-row" style="position:relative">
      <input id="searchInput" placeholder="Dbl-click on map/g√µ t·ªça ƒë·ªô, ƒë·ªãa ch·ªâ">
      <button onclick="searchLocation()">T√¨m</button>
      <!-- H·ªôp g·ª£i √Ω ƒë·ªãa ch·ªâ t·ª´ d·ªãch v·ª• Nominatim -->
      <div id="suggestBox" class="suggest-box"></div>
    </div>
    
    <!-- √î t√¨m ki·∫øm KH√ÅCH H√ÄNG -->
    <div class="search-row" style="position:relative">
      <input id="customerSearchInput" placeholder="T√¨m KH ƒë√£ b√°n (g√µ t√™n - ƒë·ªãa ch·ªâ)">
      <!-- H·ªôp g·ª£i √Ω kh√°ch h√†ng ƒë√£ b√°n (l·ªçc theo t·∫≠p ƒëi·ªÉm ƒëang hi·ªÉn th·ªã) -->
      <div id="customerSuggestBox" class="suggest-box"></div>
    </div>

  <!-- Filter theo hi·ªáu su·∫•t (thu g·ªçn) -->
<div class="filter-box">

  <div class="filter-title" onclick="toggleFilter()">
    <b>Filter hi·ªáu su·∫•t s·ª≠ d·ª•ng t·∫≠p ƒëi·ªÉm</b>
    <span id="filterArrow" style="float:right">‚ñº</span>
  </div>

  <div id="filterContent" class="filter-content">
    <label>
      <input type="checkbox" class="eff-filter" value="lt20" checked>
      &lt; 20%
    </label><br>

    <label>
      <input type="checkbox" class="eff-filter" value="20_50" checked>
      20 ‚Äì 50%
    </label><br>

    <label>
      <input type="checkbox" class="eff-filter" value="50_80" checked>
      50 ‚Äì 80%
    </label><br>

    <label>
      <input type="checkbox" class="eff-filter" value="gte80" checked>
      ‚â• 80%
    </label>
  </div>
</div>

  <!-- Export danh s√°ch c·∫ßn n√¢ng c·∫•p -->
  <div style="margin-top:6px">
    <button onclick="exportUpgradeList()" style="width:100%">
      Export DS t·∫≠p ƒëi·ªÉm c·∫ßn n√¢ng c·∫•p
    </button>
  </div>
  
  <!-- Export to√†n b·ªô t·∫≠p ƒëi·ªÉm ra KML -->
  <div style="margin-top:6px">
    <button onclick="exportAllCirclesToKML()" style="width:100%">
      Export to√†n b·ªô t·∫≠p ƒëi·ªÉm (*.KML)
    </button>
  </div>
</div>

<!-- =========================
     CH√ö GI·∫¢I M√ÄU HI·ªÜU SU·∫§T
     ========================= -->
<div class="legend hieusuat">
  <div class="legend-note">Hi·ªáu su·∫•t s·ª≠ d·ª•ng t·∫≠p ƒëi·ªÉm</div>
  <div>
    <span class="col">üîµ &lt;20%</span>
    <span class="col">üü¢ 20‚Äì50%</span>
  </div>
  <div>
    <span class="col">üü† 50‚Äì80%</span>
    <span class="col">üî¥ 80‚Äì&lt;100%</span>
  </div>
  <div>
    <span class="col">‚ö´ ‚â•100% Full</span>
  </div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- N√∫t ƒë·ªãnh v·ªã -->
<button class="locate-btn" onclick="locateMe()" title="ƒê·ªãnh v·ªã t√¥i">üìç</button>

<script>
/* =====================================================
   BI·∫æN TO√ÄN C·ª§C & C·∫§U H√åNH
   ===================================================== */

// Link Google Sheet v√† t√™n sheet d·ªØ li·ªáu
const CONFIG = {
  SHEET_ID: '1AkswJCHRClc7wAoagpRqtrG9OATm5_6qsRK0gTHZqcY',
  SHEET_TAPDIEM: 'Danh s√°ch t·∫≠p ƒëi·ªÉm S2',
  SHEET_CUSTOMER: 'Danh s√°ch kh√°ch h√†ng'
};

// ƒê·ªëi t∆∞·ª£ng map Leaflet
let map;

// Danh s√°ch to√†n b·ªô t·∫≠p ƒëi·ªÉm h·ª£p l·ªá
let allPoints = [];

// Map l∆∞u danh s√°ch kh√°ch h√†ng theo t·∫≠p ƒëi·ªÉm
// key: t√™n t·∫≠p ƒëi·ªÉm | value: m·∫£ng kh√°ch h√†ng
let customerByTapDiem = {};

// Danh s√°ch kh√°ch h√†ng ph·ª•c v·ª• search
let customerSearchList = [];

// Marker v·ªã tr√≠ kh√°ch h√†ng
let customerMarker = null;

// T·ªça ƒë·ªô kh√°ch h√†ng hi·ªán t·∫°i (null = ch∆∞a c√≥)
let customerLatLng = null;

// C√°c layer g·ª£i √Ω (line, highlight)
let suggestionLayers = [];

// C·ªù x√°c ƒë·ªãnh l·∫ßn load ƒë·∫ßu ti√™n (fitBounds)
let isInitialLoad = true;

// Marker v·ªã tr√≠ kh√°ch h√†ng khi double-click tr√™n map
let clickMarker = null;

/* =====================================================
   KH·ªûI T·∫†O MAP
   ===================================================== */

map = L.map('map', {
  doubleClickZoom: false,
  zoomControl: false
}).setView([10.8, 106.7], 11);

// Tile OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

/* Double click map ƒë·ªÉ ch·ªçn v·ªã tr√≠ kh√°ch h√†ng */
map.on("dblclick", function (e) {
  const lat = e.latlng.lat.toFixed(6);
  const lng = e.latlng.lng.toFixed(6);

  // X√≥a marker c≈©
  if (clickMarker) map.removeLayer(clickMarker);

  // T·∫°o marker m·ªõi
  clickMarker = L.marker([lat, lng]).addTo(map);

  // ƒêi·ªÅn t·ªça ƒë·ªô v√†o √¥ t√¨m ki·∫øm
  document.getElementById("searchInput").value = `${lat}, ${lng}`;

  // X·ª≠ l√Ω logic t√¨m t·∫≠p ƒëi·ªÉm
  handleCustomer(+lat, +lng);
  collapseControlBox();
});

/* =====================================================
   H√ÄM TI·ªÜN √çCH (UTILS)
   ===================================================== */

/* Ki·ªÉm tra t·ªça ƒë·ªô h·ª£p l·ªá */
function validateLatLng(lat, lng) {
  if (lat === null || lat === undefined) return false;
  if (lng === null || lng === undefined) return false;
  if (String(lat).trim() === "") return false;
  if (String(lng).trim() === "") return false;

  lat = Number(lat);
  lng = Number(lng);

  if (!Number.isFinite(lat) || !Number.isFinite(lng)) return false;
  if (lat === 0 && lng === 0) return false;

  return lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
}

/* X√°c ƒë·ªãnh m√†u theo hi·ªáu su·∫•t */
function getColor(eff) {
  if (eff < 0.2) return 'blue';
  if (eff < 0.5) return 'green';
  if (eff < 0.8) return 'orange';
  if (eff < 1) return 'red';
  return 'black';
}

/* Quy ƒë·ªïi m√†u sang format KML */
function colorToKML(color) {
  const map = {
    blue:  "7dff0000",
    green: "7d00ff00",
    orange: "7d00a5ff",
    red:   "7d0000ff",
    black: "7d000000"
  };
  return map[color] || "7dffffff";
}

/* T√≠nh kho·∫£ng c√°ch Haversine (m√©t) */
function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a = Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

/* Chuy·ªÉn circle Leaflet th√†nh polygon cho KML */
function circleToPolygon(lat, lng, radiusMeters, points = 60) {
  const coords = [];
  const earthRadius = 6378137;

  for (let i = 0; i <= points; i++) {
    const angle = (i / points) * 2 * Math.PI;
    const dx = radiusMeters * Math.cos(angle);
    const dy = radiusMeters * Math.sin(angle);

    const dLat = dy / earthRadius;
    const dLng = dx / (earthRadius * Math.cos(lat * Math.PI / 180));

    const latPoint = lat + dLat * 180 / Math.PI;
    const lngPoint = lng + dLng * 180 / Math.PI;

    coords.push(`${lngPoint},${latPoint},0`);
  }

  return coords.join(" ");
}

function renderCustomerList(tapDiemName) {
  const list = customerByTapDiem[tapDiemName] || [];

  if (!list.length) {
    return `<i>Kh√¥ng c√≥ kh√°ch h√†ng trong t·∫≠p ƒëi·ªÉm n√†y</i>`;
  }

  let html = `
    <div style="max-height:200px; overflow:auto; font-size:12px">
      <table border="1" cellpadding="4" cellspacing="0" width="100%">
        <tr style="background:#f0f0f0">
          <th>T√™n KH</th>
          <th>ƒê·ªãa ch·ªâ</th>
          <th>Tr·∫°ng th√°i</th>
        </tr>
  `;

  list.forEach(c => {
    const isNormal = c.status === 'Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng';
  
    html += `
      <tr style="${isNormal ? '' : 'background:#ffe6e6; color:#b30000;'}">
        <td>${c.name || ''}</td>
        <td>${c.address || ''}</td>
        <td>${c.status || ''}</td>
      </tr>
    `;
  });

  html += `</table></div>`;
  return html;
}

// Hi·ªÉn th·ªã danh s√°ch kh√°ch h√†ng trong popup t·∫≠p ƒëi·ªÉm
function showCustomer(tapDiemName) {
  const el = document.getElementById(`customer-${tapDiemName}`);
  if (!el) return;
  el.innerHTML = renderCustomerList(tapDiemName);
}

/* =====================================================
   LOAD D·ªÆ LI·ªÜU GOOGLE SHEET
   ===================================================== */

google.charts.load('current', { packages: ['corechart'] });
google.charts.setOnLoadCallback(() => {
  loadData();
  loadCustomerData();
});

/* ƒê·ªçc d·ªØ li·ªáu t·ª´ Google Sheet */
function loadData() {
  const query = new google.visualization.Query(
    `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(CONFIG.SHEET_TAPDIEM)}`
  );

  query.send(res => {
    // ‚úÖ KI·ªÇM TRA L·ªñI GOOGLE SHEET
    if (res.isError()) {
      alert("‚ùå Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu Google Sheet (Danh s√°ch t·∫≠p ƒëi·ªÉm)");
      console.error("Google Sheet error:", res.getMessage(), res.getDetailedMessage());
      return;
    }
    const data = res.getDataTable();

    // Mapping c·ªôt Sheet "Danh s√°ch t·∫≠p ƒëi·ªÉm S2":
    // [2] T√™n t·∫≠p ƒëi·ªÉm | [3] T·ªïng port | [4] Port ƒë√£ d√πng
    // [5] Port c√≤n l·∫°i | [7] Hi·ªáu su·∫•t | [9][10] T·ªça ƒë·ªô
    for (let i = 0; i < data.getNumberOfRows(); i++) {
      const lat = Number(data.getValue(i, 9));
      const lng = Number(data.getValue(i, 10));
      if (!validateLatLng(lat, lng)) continue;

      const eff = Number(data.getValue(i, 7));

      // V·∫Ω v√≤ng tr√≤n t·∫≠p ƒëi·ªÉm
      const circle = L.circle([lat, lng], {
        radius: 225,
        color: getColor(eff),
        fillColor: getColor(eff),
        fillOpacity: 0.5,
        weight: 2
      });

      // Popup th√¥ng tin t·∫≠p ƒëi·ªÉm FTTH
      const basePopup = `
        <b>${data.getValue(i, 2)}</b><br>
      
        <b>T·ªça ƒë·ªô:</b>
        <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank">
          ${lat.toFixed(6)}, ${lng.toFixed(6)}
        </a><br>
      
        <b>D·∫´n ƒë∆∞·ªùng:</b>
        <span class="direction-holder" data-lat="${lat}" data-lng="${lng}">
        <i style="color:#999">Ch∆∞a l·∫•y ƒë∆∞·ª£c v·ªã tr√≠ kh√°ch h√†ng</i>
        </span><br>
      
        <b>Dung l∆∞·ª£ng:</b> ${data.getValue(i, 3)} Port<br>
        <b>ƒê√£ d√πng:</b> ${data.getValue(i, 4)}<br>
        <b>C√≤n l·∫°i:</b> ${data.getValue(i, 5)}<br>
        <b>Hi·ªáu su·∫•t:</b> ${(eff * 100).toFixed(1)}%
        <hr>
      
        <a href="#" onclick="event.preventDefault(); showCustomer('${data.getValue(i, 2)}')">
          üìã Xem danh s√°ch kh√°ch h√†ng
        </a>
      
        <div id="customer-${data.getValue(i, 2)}" style="margin-top:6px"></div>
      `;
      
      circle.bindPopup(basePopup);

      circle.on("popupopen", e => {
        const popupEl = e.popup.getElement();
        if (!popupEl) return;
      
        const holder = popupEl.querySelector(".direction-holder");
        if (!holder) return;
      
        const lat = holder.dataset.lat;
        const lng = holder.dataset.lng;
      
        holder.innerHTML = renderDirection(lat, lng);
      });

      // L∆∞u th√¥ng tin t·∫≠p ƒëi·ªÉm
      allPoints.push({
        name: data.getValue(i, 2),
        maxPort: data.getValue(i, 3),
        usedPort: data.getValue(i, 4),
        freePort: data.getValue(i, 5),
        eff, lat, lng,
        circle,
        basePopup   // ‚≠ê L∆ØU POPUP G·ªêC
      });
    }

    renderPoints();
  });
}

function loadCustomerData() {
  const query = new google.visualization.Query(
    `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(CONFIG.SHEET_CUSTOMER)}`
  );

  query.send(res => {
    // ‚úÖ KI·ªÇM TRA L·ªñI GOOGLE SHEET
    if (res.isError()) {
      alert("‚ùå Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu Google Sheet (Danh s√°ch t·∫≠p ƒëi·ªÉm)");
      console.error("Google Sheet error:", res.getMessage(), res.getDetailedMessage());
      return;
    }
    const data = res.getDataTable();

    for (let i = 0; i < data.getNumberOfRows(); i++) {
      const tenKH   = data.getValue(i, 5);   // C·ªôt F
      const tapDiem = data.getValue(i, 13);  // C·ªôt N
      const diaChi  = data.getValue(i, 8);   // C·ªôt I (c√≥ d·∫•u , OK)
      const status  = data.getValue(i, 15);  // C·ªôt P

      if (!tapDiem) continue;

      if (!customerByTapDiem[tapDiem]) {
        customerByTapDiem[tapDiem] = [];
      }

      customerByTapDiem[tapDiem].push({
        name: tenKH,
        address: diaChi,
        status
      });
      
      customerSearchList.push({
        name: tenKH,
        address: diaChi,
        tapDiem: tapDiem,
        status: status
      });
    }

    console.log("ƒê√£ load danh s√°ch KH theo t·∫≠p ƒëi·ªÉm", customerByTapDiem);
  });
}

function getVisibleTapDiemNames() {
  return allPoints
    .filter(p => map.hasLayer(p.circle))
    .map(p => p.name);
}
  
/* =====================================================
   HI·ªÇN TH·ªä T·∫¨P ƒêI·ªÇM
   ===================================================== */

function renderPoints() {
  const bounds = [];

  allPoints.forEach(p => {
    p.circle.addTo(map);
    bounds.push([p.lat, p.lng]);
  });

  // Zoom bao to√†n b·ªô t·∫≠p ƒëi·ªÉm ·ªü l·∫ßn load ƒë·∫ßu
  if (isInitialLoad && bounds.length) {
    map.fitBounds(bounds, { padding: [40, 40] });
    isInitialLoad = false;
  }
}

/* =====================================================
   FILTER THEO HI·ªÜU SU·∫§T
   ===================================================== */

function applyFilter() {
  // L·∫•y t·∫•t c·∫£ checkbox ƒëang ƒë∆∞·ª£c tick
  const checked = Array.from(
    document.querySelectorAll('.eff-filter:checked')
  ).map(cb => cb.value);

  allPoints.forEach(p => {
    let show = false;

    checked.forEach(v => {
      if (v === 'lt20'   && p.eff < 0.2) show = true;
      if (v === '20_50'  && p.eff >= 0.2 && p.eff < 0.5) show = true;
      if (v === '50_80'  && p.eff >= 0.5 && p.eff < 0.8) show = true;
      if (v === 'gte80'  && p.eff >= 0.8) show = true;
    });

    show ? p.circle.addTo(map) : map.removeLayer(p.circle);
  });
}

/* =====================================================
   T√åM KI·∫æM KH√ÅCH H√ÄNG
   ===================================================== */

function searchLocation() {
  const val = searchInput.value.trim();
  if (!val) return;

  // Nh·∫≠p t·ªça ƒë·ªô tr·ª±c ti·∫øp
  const p = val.split(',');
  if (p.length === 2 && !isNaN(p[0]) && !isNaN(p[1])) {
    handleCustomer(+p[0], +p[1]);
    return;
  }

  // T√¨m theo ƒë·ªãa ch·ªâ (Nominatim)
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`)
    .then(r => r.json())
    .then(r => r[0] && handleCustomer(+r[0].lat, +r[0].lon));

  collapseControlBox();
}

/* =====================================================
   X·ª¨ L√ù LOGIC KH√ÅCH H√ÄNG & G·ª¢I √ù T·∫¨P ƒêI·ªÇM
   ===================================================== */
/*
X·ª≠ l√Ω khi x√°c ƒë·ªãnh v·ªã tr√≠ kh√°ch h√†ng:
- Reset marker & highlight c≈©
- Ki·ªÉm tra ph·∫°m vi b√°n h√†ng ‚â§ 1km
- Ch·ªçn t·ªëi ƒëa 3 t·∫≠p ƒëi·ªÉm g·∫ßn nh·∫•t c√≤n port
- Highlight, v·∫Ω ƒë∆∞·ªùng v√† hi·ªÉn th·ªã g·ª£i √Ω
*/
function handleCustomer(lat, lng) {
  customerLatLng = { lat, lng };
  // X√≥a marker & layer c≈©
  if (customerMarker) map.removeLayer(customerMarker);
  suggestionLayers.forEach(l => map.removeLayer(l));
  suggestionLayers = [];

  // Reset style t·∫≠p ƒëi·ªÉm
  allPoints.forEach(p => {
    p.circle.setStyle({ weight: 2 });
    p.circle.setPopupContent(p.basePopup); // üëà reset popup
    const el = p.circle.getElement();
    if (el) el.classList.remove('blink');
  });

  // Marker kh√°ch h√†ng
  customerMarker = L.marker([lat, lng]).addTo(map);
  map.setView([lat, lng], 15);
  
  // ===============================
  // Ki·ªÉm tra kho·∫£ng c√°ch t·ªõi t·∫≠p ƒëi·ªÉm g·∫ßn nh·∫•t ‚â§ 1km
  // ===============================
  const nearestPoint = allPoints
    .map(p => ({ ...p, dist: haversine(lat, lng, p.lat, p.lng) }))
    .sort((a, b) => a.dist - b.dist)[0];
  
  if (!nearestPoint || nearestPoint.dist > 1000) {
    alert(
      `‚ùå Kh√¥ng kh·∫£ thi ƒë·ªÉ b√°n h√†ng\n` +
      `T·∫≠p ƒëi·ªÉm g·∫ßn nh·∫•t c√°ch ${Math.round(nearestPoint?.dist || 0)} m`
    );
    return;
  }

  // Ch·ªçn 3 t·∫≠p ƒëi·ªÉm g·∫ßn nh·∫•t c√≤n port tr·ªëng
  const candidates = allPoints
    .filter(p => p.freePort > 0)
    .map(p => ({ ...p, dist: haversine(lat, lng, p.lat, p.lng) }))
    .sort((a, b) => a.dist - b.dist || a.eff - b.eff)
    .slice(0, 3);

  candidates.forEach((p, i) => {
    const el = p.circle.getElement();
    if (el) el.classList.add('blink');

    p.circle.setStyle({ weight: 4 });

    // V·∫Ω ƒë∆∞·ªùng n·ªëi kh√°ch h√†ng ‚Üí t·∫≠p ƒëi·ªÉm
    const line = L.polyline(
      [[lat, lng], [p.lat, p.lng]],
      { color: 'green', dashArray: '5,5' }
    ).addTo(map);

    // Hi·ªÉn th·ªã kho·∫£ng c√°ch
    line.bindTooltip(`${Math.round(p.dist)} m`, {
      permanent: true,
      direction: 'center'
    });

    // Popup chi ti·∫øt t·∫≠p ƒëi·ªÉm g·ª£i √Ω quanh v·ªã tr√≠ kh√°ch h√†ng
    const bestBadge =
      i === 0
        ? '<b style="color:green">‚≠ê T·∫¨P ƒêI·ªÇM T·ªêT NH·∫§T</b>'
        : '';
    
    const suggestPopup = `
      ${p.basePopup}
      <hr>
      <b>Kho·∫£ng c√°ch:</b> ${Math.round(p.dist)} m<br>
      ${bestBadge}
    `;
    
    p.circle.setPopupContent(suggestPopup);

    suggestionLayers.push(line);
  });
}

/* =====================================================
   EXPORT D·ªÆ LI·ªÜU
   ===================================================== */

/* Export danh s√°ch t·∫≠p ƒëi·ªÉm c·∫ßn n√¢ng c·∫•p ra Excel */
function exportUpgradeList() {
  const rows = [[
    'T√™n t·∫≠p ƒëi·ªÉm',
    'Lat',
    'Long',
    'Dung l∆∞·ª£ng (Port)',
    'Port ƒë√£ d√πng',
    'Port c√≤n l·∫°i',
    'Hi·ªáu su·∫•t (%)',
    'M·ª©c ∆∞u ti√™n'
  ]];

  allPoints.forEach(p => {
    if (p.eff >= 0.8) {
      rows.push([
        p.name,
        p.lat,
        p.lng,
        p.maxPort,
        p.usedPort,
        p.freePort,
        (p.eff * 100).toFixed(1),
        p.eff >= 1
          ? '∆Øu ti√™n 1 (Full)'
          : '∆Øu ti√™n 2 (G·∫ßn full)'
      ]);
    }
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Upgrade');
  XLSX.writeFile(wb, 'DS_tap_diem_can_nang_cap.xlsx');
}

/* Export to√†n b·ªô t·∫≠p ƒëi·ªÉm ra file KML */
function exportAllCirclesToKML() {
  let placemarks = "";

  allPoints.forEach(p => {
    const polygon = circleToPolygon(p.lat, p.lng, 225);
    const color = colorToKML(getColor(p.eff));

    const description = `
      <![CDATA[
        <b>${p.name}</b><br>
        Dung l∆∞·ª£ng (Port): ${p.maxPort}<br>
        ƒê√£ d√πng: ${p.usedPort}<br>
        C√≤n l·∫°i: ${p.freePort}<br>
        Hi·ªáu su·∫•t: ${(p.eff * 100).toFixed(1)}%
      ]]>
    `;

    placemarks += `
      <Placemark>
        <name>${p.name}</name>
        <description>${description}</description>
        <Style>
          <PolyStyle>
            <color>${color}</color>
            <outline>1</outline>
          </PolyStyle>
          <LineStyle>
            <color>ff854442</color>
            <width>2</width>
          </LineStyle>
        </Style>
        <Polygon>
          <outerBoundaryIs>
            <LinearRing>
              <coordinates>
                ${polygon}
              </coordinates>
            </LinearRing>
          </outerBoundaryIs>
        </Polygon>
      </Placemark>
    `;
  });

  const kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
  <name>V√πng ph·ªß GPON MobiFiber</name>
  ${placemarks}
</Document>
</kml>`;

  downloadKML(kml, "Vung_phu_GPON_MobiFiber.kml");
}

/* T·∫£i file KML */
function downloadKML(content, filename) {
  const blob = new Blob([content], {
    type: "application/vnd.google-earth.kml+xml"
  });

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

/* =====================================================
   AUTOCOMPLETE & ƒê·ªäNH V·ªä
   ===================================================== */

const input = document.getElementById("searchInput");
const suggestBox = document.getElementById("suggestBox");
const customerInput = document.getElementById("customerSearchInput");
const customerSuggestBox = document.getElementById("customerSuggestBox");
// Timer debounce autocomplete ƒë·ªÉ tr√°nh g·ªçi API li√™n t·ª•c
let suggestTimer = null;

/* Autocomplete ƒë·ªãa ch·ªâ */
input.addEventListener("input", () => {
  const q = input.value.trim();
  
  if (!q) {
    customerLatLng = null;         
    suggestBox.style.display = "none";
    return;
  }
  
  if (q.length < 3) {
    suggestBox.style.display = "none";
    return;
  }

  clearTimeout(suggestTimer);
  suggestTimer = setTimeout(() => {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`)
      .then(r => r.json())
      .then(data => {
        suggestBox.innerHTML = "";
        if (!data.length) {
          suggestBox.style.display = "none";
          return;
        }

        data.forEach(item => {
          const div = document.createElement("div");
          div.className = "suggest-item";
          div.textContent = item.display_name;

          div.onclick = () => {
            input.value = item.display_name;
            suggestBox.style.display = "none";
            handleCustomer(+item.lat, +item.lon);
          };

          suggestBox.appendChild(div);
        });

        suggestBox.style.display = "block";
      });
  }, 300);
});

customerInput.addEventListener("input", () => {
  const q = customerInput.value.trim().toLowerCase();
  customerSuggestBox.innerHTML = "";

  if (q.length < 2) {
    customerSuggestBox.style.display = "none";
    return;
  }

  const visibleTapDiems = getVisibleTapDiemNames();

  const matches = customerSearchList
    .filter(c =>
      visibleTapDiems.includes(c.tapDiem) &&
      (
        (c.name && c.name.toLowerCase().includes(q)) ||
        (c.address && c.address.toLowerCase().includes(q))
      )
    )
    .slice(0, 10);

  if (!matches.length) {
    customerSuggestBox.style.display = "none";
    return;
  }

  matches.forEach(c => {
    const div = document.createElement("div");
    div.className = "suggest-item";
    div.innerHTML = `<b>${c.name}</b> ‚Äì ${c.address || ''}`;

    div.onclick = () => {
      customerInput.value = `${c.name} - ${c.address || ''}`;
      customerSuggestBox.style.display = "none";
      locateCustomerInTapDiem(c);
      collapseControlBox();
    };

    customerSuggestBox.appendChild(div);
  });

  customerSuggestBox.style.display = "block";
});

/* ·∫®n g·ª£i √Ω khi click ngo√†i */
document.addEventListener("click", e => {
  if (!e.target.closest(".search-row")) {
    suggestBox.style.display = "none";
    customerSuggestBox.style.display = "none";
  }
});

/* ƒê·ªãnh v·ªã ng∆∞·ªùi d√πng */
let myLocationMarker = null;
// V√≤ng tr√≤n th·ªÉ hi·ªán sai s·ªë ƒë·ªãnh v·ªã (accuracy)
let myAccuracyCircle = null;

function locateMe() {
  if (!navigator.geolocation) {
    alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const accuracy = pos.coords.accuracy;

      if (myLocationMarker) map.removeLayer(myLocationMarker);
      if (myAccuracyCircle) map.removeLayer(myAccuracyCircle);

      myLocationMarker = L.marker([lat, lng])
        .addTo(map)
        .bindPopup("üìç V·ªã tr√≠ c·ªßa t√¥i")
        .openPopup();

      myAccuracyCircle = L.circle([lat, lng], {
        radius: accuracy,
        color: "blue",
        fillColor: "blue",
        fillOpacity: 0.1
      }).addTo(map);

      map.setView([lat, lng], 15);
      handleCustomer(lat, lng);
      collapseControlBox();
    },
    err => alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠: " + err.message),
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

/* =====================================================
   THU G·ªåN / M·ªû R·ªòNG PANEL
   ===================================================== */

function toggleControl() {
  const box = document.getElementById("controlBox");
  const arrow = document.getElementById("arrow");

  box.classList.toggle("collapsed");
  arrow.textContent = box.classList.contains("collapsed") ? "‚ñº" : "‚ñ≤";
}

function toggleFilter() {
  const content = document.getElementById("filterContent");
  const arrow = document.getElementById("filterArrow");

  const isOpen = content.style.display === "block";

  content.style.display = isOpen ? "none" : "block";
  arrow.textContent = isOpen ? "‚ñº" : "‚ñ≤";
}

function collapseControlBox() {
  const box = document.getElementById("controlBox");
  const arrow = document.getElementById("arrow");

  if (!box.classList.contains("collapsed")) {
    box.classList.add("collapsed");
    arrow.textContent = "‚ñº";
  }
}

  document.querySelectorAll('.eff-filter')
  .forEach(cb => cb.addEventListener('change', applyFilter));

function locateCustomerInTapDiem(customer) {
  customerLatLng = null;
  const p = allPoints.find(tp => tp.name === customer.tapDiem);
  if (!p) {
    alert("Kh√¥ng t√¨m th·∫•y t·∫≠p ƒëi·ªÉm c·ªßa kh√°ch h√†ng");
    return;
  }

  map.setView([p.lat, p.lng], 16);
  p.circle.openPopup();

  allPoints.forEach(x => {
    x.circle.setStyle({ weight: 2 });
    const el = x.circle.getElement();
    if (el) el.classList.remove("blink");
  });

  p.circle.setStyle({ weight: 4 });
  const el = p.circle.getElement();
  if (el) el.classList.add("blink");

  setTimeout(() => {
    showCustomer(p.name);

    const rows = document.querySelectorAll(
      `#customer-${p.name} table tr`
    );

    rows.forEach(r => {
      if (r.innerText.includes(customer.name)) {
        r.style.background = "#fff3cd";
        r.style.fontWeight = "bold";
      }
    });
  }, 300);
}

function renderDirection(lat, lng) {
  if (!customerLatLng) {
    return `<i style="color:#999">Ch∆∞a l·∫•y ƒë∆∞·ª£c v·ªã tr√≠ kh√°ch h√†ng</i>`;
  }

  const url =
    `https://www.google.com/maps/dir/?api=1` +
    `&origin=${customerLatLng.lat},${customerLatLng.lng}` +
    `&destination=${lat},${lng}`;

  return `
    <a href="${url}" target="_blank" rel="noopener">
      üß≠ Ch·ªâ ƒë∆∞·ªùng tr√™n Google Maps
    </a>
  `;

}

</script>
<!-- LOGO G√ìC TR√ÅI D∆Ø·ªöI -->
<div class="branding">
  üì∂PH√íNG VI·ªÑN TH√îNG
</div>
<script>
fetch(
  "https://script.google.com/macros/s/AKfycbypr-0OMKp6UopO_-cET65QxdwTpeoMV9q13nJMdt3PBR-GtTHkKBrfHsdqTJR24bko/exec"
  + "?url=" + encodeURIComponent(window.location.href)
  + "&v=1",
  { mode: "no-cors" }
);
</script>
</body>
</html>












