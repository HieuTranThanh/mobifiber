<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>B·∫£n ƒë·ªì hi·ªáu su·∫•t FTTH GPON</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { margin:0; font-family: Arial; }
#map { height: 100vh; }
.control {
  position:absolute; top:10px; left:10px;
  background:#fff; padding:10px;
  z-index:1000; border-radius:6px;
  box-shadow:0 0 5px rgba(0,0,0,.3);
}
.blink {
  animation: blink 1s infinite;
}
@keyframes blink {
  0% {opacity:1}
  50% {opacity:0.3}
  100% {opacity:1}
}
</style>
</head>

<body>
<div class="control">
  <b>L·ªçc hi·ªáu su·∫•t</b><br>
  <select id="filter">
    <option value="all">T·∫•t c·∫£</option>
    <option value="1">&lt; 20%</option>
    <option value="2">20‚Äì50%</option>
    <option value="3">50‚Äì80%</option>
    <option value="4">80‚Äì100%</option>
    <option value="5">&ge;100%</option>
  </select><br><br>

  <input id="search" placeholder="Nh·∫≠p v·ªã tr√≠ t√¨m ki·∫øm" style="width:180px">
  <button onclick="searchLocation()">T√¨m</button><br><br>

  <button onclick="exportExcel()">üì§ Xu·∫•t t·∫≠p ƒëi·ªÉm c·∫ßn n√¢ng c·∫•p</button>
</div>

<div id="map"></div>

<script>
const sheetURL =
"https://docs.google.com/spreadsheets/d/1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq/gviz/tq?tqx=out:csv&sheet=Danh s√°ch t·∫≠p ƒëi·ªÉm S2";

const map = L.map('map').setView([10.8,106.7], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let circles = [];
let dataPoints = [];

function getColor(p){
  if(p>=1) return "black";
  if(p>=0.8) return "red";
  if(p>=0.5) return "yellow";
  if(p>=0.2) return "green";
  return "blue";
}

Papa.parse(sheetURL,{
  download:true,
  header:true,
  complete:(res)=>{
    res.data.forEach(r=>{
      let lat=parseFloat(r["Latitude"]);
      let lng=parseFloat(r["Longitude"]);
      if(isNaN(lat)||isNaN(lng)) return;

      let eff=parseFloat(r["Hi·ªáu su·∫•t s·ª≠ d·ª•ng"]);
      let circle=L.circle([lat,lng],{
        radius:300,
        color:getColor(eff),
        fillColor:getColor(eff),
        fillOpacity:0.4
      }).bindPopup(`
        <b>${r["T√™n t·∫≠p ƒëi·ªÉm"]}</b><br>
        ${r["ƒê·ªãa ch·ªâ"]}<br>
        T·ªïng port: ${r["Dung l∆∞·ª£ng t·ªëi ƒëa (port)"]}<br>
        ƒê√£ d√πng: ${r["S·ªë port ƒë√£ d√πng"]}<br>
        C√≤n l·∫°i: ${r["S·ªë port c√≤n l·∫°i"]}<br>
        Hi·ªáu su·∫•t: ${(eff*100).toFixed(1)}%
      `).addTo(map);

      circle.meta={eff,lat,lng,...r};
      circles.push(circle);
      dataPoints.push(circle.meta);
    });
    let group=L.featureGroup(circles);
    map.fitBounds(group.getBounds());
  }
});

document.getElementById("filter").onchange=function(){
  circles.forEach(c=>{
    let e=c.meta.eff;
    let v=this.value;
    let show =
      v=="all" ||
      (v==1 && e<0.2) ||
      (v==2 && e>=0.2&&e<0.5) ||
      (v==3 && e>=0.5&&e<0.8) ||
      (v==4 && e>=0.8&&e<1) ||
      (v==5 && e>=1);
    show ? c.addTo(map) : map.removeLayer(c);
  });
}

function distance(a,b){
  return map.distance(a,b);
}

function searchLocation(){
  let q=document.getElementById("search").value;
  if(q.includes(",")){
    let [lat,lng]=q.split(",").map(Number);
    handleSearch(lat,lng);
  }else{
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
    .then(r=>r.json())
    .then(d=>{
      if(d[0]) handleSearch(+d[0].lat,+d[0].lon);
    });
  }
}

function handleSearch(lat,lng){
  map.setView([lat,lng],16);
  L.marker([lat,lng]).addTo(map).bindPopup("V·ªã tr√≠ kh√°ch h√†ng").openPopup();

  let candidates=dataPoints
    .filter(d=>d["S·ªë port c√≤n l·∫°i"]>0)
    .map(d=>({...d,dist:distance([lat,lng],[d.lat,d.lng])}))
    .sort((a,b)=>a.dist-b.dist)
    .slice(0,3);

  circles.forEach(c=>{
    if(candidates.find(x=>x.lat==c.meta.lat)){
      c.setStyle({weight:4});
      c._path.classList.add("blink");
      c.bindPopup(c.getPopup().getContent()+`<br>Kho·∫£ng c√°ch: ${Math.round(distance([lat,lng],[c.meta.lat,c.meta.lng]))} m`);
    }
  });
}

function exportExcel(){
  let rows=dataPoints
    .filter(d=>d["Hi·ªáu su·∫•t s·ª≠ d·ª•ng"]>=0.8)
    .map(d=>({
      "T√™n t·∫≠p ƒëi·ªÉm":d["T√™n t·∫≠p ƒëi·ªÉm"],
      Latitude:d.lat,
      Longitude:d.lng,
      "ƒê·ªãa ch·ªâ":d["ƒê·ªãa ch·ªâ"],
      "Hi·ªáu su·∫•t":d["Hi·ªáu su·∫•t s·ª≠ d·ª•ng"]*100+"%",
      "∆Øu ti√™n": d["Hi·ªáu su·∫•t s·ª≠ d·ª•ng"]>=1?"∆Øu ti√™n 1":"∆Øu ti√™n 2"
    }));
  let ws=XLSX.utils.json_to_sheet(rows);
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"N√¢ng c·∫•p");
  XLSX.writeFile(wb,"tap_diem_can_nang_cap.xlsx");
}
</script>
</body>
</html>
