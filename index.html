<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>B·∫£n ƒë·ªì FTTH GPON</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Control Geocoder (SEARCH) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
  />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .legend {
      background: white;
      padding: 10px;
      line-height: 1.5;
      font-size: 14px;
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 6px;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
/* ================== INIT MAP ================== */
const map = L.map("map").setView([10.762622, 106.660172], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

/* ================== SEARCH BOX ================== */
L.Control.geocoder({
  position: "topleft",
  placeholder: "Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t·ªça ƒë·ªô (lat,lng)",
  defaultMarkGeocode: false
})
.on("markgeocode", function(e) {
  const center = e.geocode.center;

  L.marker(center)
    .addTo(map)
    .bindPopup("üìç V·ªã tr√≠ kh√°ch h√†ng")
    .openPopup();

  map.setView(center, 16);
})
.addTo(map);

/* ================== COLOR LOGIC ================== */
function getColor(eff) {
  if (eff < 50) return "green";
  if (eff < 80) return "yellow";
  if (eff < 100) return "red";
  return "black";
}

/* ================== GOOGLE SHEET ================== */
const sheetUrl =
  "https://docs.google.com/spreadsheets/d/1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq/gviz/tq?" +
  "sheet=Danh%20s√°ch%20t·∫≠p%20ƒëi·ªÉm%20S2&tq=select%20*";

/* ================== LOAD DATA ================== */
fetch(sheetUrl)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(
      text.substring(
        text.indexOf("{"),
        text.lastIndexOf("}") + 1
      )
    );

    const rows = json.table.rows;

    rows.forEach(row => {
      if (!row.c) return;

      const name = row.c[2]?.v;
      const totalPort = row.c[3]?.v;
      const usedPort = row.c[4]?.v;
      const freePort = row.c[5]?.v;

      // Percentage (0‚Äì1) ‚Üí %
      const efficiency = row.c[7]?.v * 100;

      const lat = row.c[9]?.v;
      const lng = row.c[10]?.v;

      if (!lat || !lng) return;

      const color = getColor(efficiency);

      L.circle([lat, lng], {
        radius: 300,
        color: color,
        fillColor: color,
        fillOpacity: 0.4
      })
      .addTo(map)
      .bindPopup(`
        <b>${name}</b><br/>
        T·ªïng port: ${totalPort}<br/>
        ƒê√£ d√πng: ${usedPort}<br/>
        C√≤n l·∫°i: ${freePort}<br/>
        Hi·ªáu su·∫•t: ${efficiency.toFixed(1)}%
      `);
    });
  })
  .catch(err => {
    console.error(err);
    alert("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu Google Sheet");
  });

/* ================== LEGEND ================== */
const legend = L.control({ position: "bottomright" });

legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <b>Hi·ªáu su·∫•t s·ª≠ d·ª•ng</b><br/>
    <span style="background:green"></span> < 50%<br/>
    <span style="background:yellow"></span> 50‚Äì80%<br/>
    <span style="background:red"></span> 80‚Äì100%<br/>
    <span style="background:black"></span> ‚â• 100%
  `;
  return div;
};

legend.addTo(map);
</script>
</body>
</html>
