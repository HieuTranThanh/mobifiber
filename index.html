<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Bản đồ hiệu suất FTTH – GPON</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }
#map { height:100vh; }

.control-box {
  position:absolute;
  top:10px; left:10px;
  background:#fff;
  padding:10px;
  z-index:1000;
  width:260px;
  border-radius:6px;
  box-shadow:0 0 6px rgba(0,0,0,.3);
  font-size:13px;
}

.control-box input,
.control-box select,
.control-box button {
  width:100%;
  margin-top:6px;
}
</style>
</head>

<body>
<div id="map"></div>

<div class="control-box">
  <b>Tìm khách hàng</b>
  <input id="searchInput" placeholder="Địa chỉ hoặc lat,lng">
  <button onclick="searchLocation()">Tìm</button>
</div>

<script>
google.charts.load('current', {packages:['corechart']});

const SHEET_URL =
 'https://docs.google.com/spreadsheets/d/1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq/gviz/tq?sheet=Danh%20sách%20tập%20điểm%20S2';

let map = L.map('map').setView([16,108],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let allPoints = [];
let circles = [];
let customerMarker = null;
let suggestLayers = [];
let pulseTimers = [];

/* ================= UTIL ================= */
function isValidCoord(lat,lng){
  lat=Number(lat); lng=Number(lng);
  return !isNaN(lat)&&!isNaN(lng)&&lat>=-90&&lat<=90&&lng>=-180&&lng<=180;
}

function haversine(a,b){
  const R=6371000;
  const dLat=(b.lat-a.lat)*Math.PI/180;
  const dLng=(b.lng-a.lng)*Math.PI/180;
  const la1=a.lat*Math.PI/180;
  const la2=b.lat*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.sin(dLng/2)**2*Math.cos(la1)*Math.cos(la2);
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function getColor(r){
  if(r>=1) return '#000';
  if(r>=0.8) return '#e74c3c';
  if(r>=0.5) return '#f1c40f';
  if(r>=0.2) return '#2ecc71';
  return '#1e90ff';
}

/* ================= LOAD ================= */
google.charts.setOnLoadCallback(()=>{
  const q=new google.visualization.Query(SHEET_URL);
  q.send(res=>{
    const dt=res.getDataTable();
    for(let i=0;i<dt.getNumberOfRows();i++){
      const lat=dt.getValue(i,9);
      const lng=dt.getValue(i,10);
      if(!isValidCoord(lat,lng)) continue;

      allPoints.push({
        name:dt.getValue(i,2),
        free:dt.getValue(i,5),
        rate:dt.getValue(i,7),
        lat:+lat, lng:+lng
      });
    }
    drawPoints();
  });
});

/* ================= DRAW ================= */
function drawPoints(){
  let bounds=[];
  allPoints.forEach(p=>{
    const c=L.circle([p.lat,p.lng],{
      radius:300,
      color:getColor(p.rate),
      fillColor:getColor(p.rate),
      fillOpacity:0.6,
      weight:1
    }).addTo(map);
    c.pointData=p;
    circles.push(c);
    bounds.push([p.lat,p.lng]);
  });
  map.fitBounds(bounds);
}

/* ================= SEARCH ================= */
function searchLocation(){
  const q=document.getElementById('searchInput').value.trim();
  if(!q) return;

  if(q.includes(',')){
    const [lat,lng]=q.split(',').map(Number);
    focusCustomer({lat,lng});
  }else{
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
      .then(r=>r.json())
      .then(d=>{
        if(d.length) focusCustomer({lat:+d[0].lat,lng:+d[0].lon});
      });
  }
}

function focusCustomer(pos){
  clearSuggest();
  if(customerMarker) map.removeLayer(customerMarker);
  customerMarker=L.marker([pos.lat,pos.lng]).addTo(map);
  map.setView([pos.lat,pos.lng],16);
  suggestBestPoints(pos);
}

/* ================= EFFECT ================= */
function clearSuggest(){
  suggestLayers.forEach(l=>map.removeLayer(l));
  suggestLayers=[];
  pulseTimers.forEach(t=>clearInterval(t));
  pulseTimers=[];
  circles.forEach(c=>c.setStyle({weight:1,opacity:1}));
}

function pulse(circle,strong){
  let on=true;
  const timer=setInterval(()=>{
    circle.setStyle({
      opacity:on?0.3:1,
      weight:strong?6:4
    });
    on=!on;
  },500);
  pulseTimers.push(timer);
}

/* ================= SUGGEST ================= */
function suggestBestPoints(pos){
  const list=allPoints
    .filter(p=>p.free>0)
    .map(p=>({...p,dist:haversine(pos,p)}))
    .sort((a,b)=>a.dist-b.dist||a.rate-b.rate)
    .slice(0,3);

  list.forEach((p,i)=>{
    const c=circles.find(x=>x.pointData===p);
    if(!c) return;

    pulse(c,i===0);

    const line=L.polyline([[pos.lat,pos.lng],[p.lat,p.lng]],{
      dashArray:'5,5'
    }).addTo(map);

    const mid={
      lat:(pos.lat+p.lat)/2,
      lng:(pos.lng+p.lng)/2
    };

    const label=L.marker(mid,{opacity:0})
      .addTo(map)
      .bindTooltip(`${Math.round(p.dist)} m`,{
        permanent:true,
        direction:'top'
      });

    suggestLayers.push(line,label);
  });
}
</script>
</body>
</html>
