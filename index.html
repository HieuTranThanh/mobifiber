<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Bản đồ hiệu suất FTTH GPON</title>

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Google Visualization -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<style>
  body { margin: 0; font-family: Arial, sans-serif; }
  #map { height: 100vh; }

  .panel {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,.25);
    width: 320px;
  }

  .panel input, .panel select, .panel button {
    width: 100%;
    margin-top: 5px;
    padding: 6px;
  }

  .legend {
    margin-top: 10px;
    font-size: 13px;
  }

  .legend div {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
  }

  .color-box {
    width: 16px;
    height: 16px;
    margin-right: 6px;
  }

  .best {
    font-weight: bold;
    color: #d32f2f;
  }
</style>
</head>

<body>

<div class="panel">
  <b>Tìm khách hàng</b>
  <input id="searchInput" placeholder="Địa chỉ hoặc lat,long" />
  <button onclick="searchLocation()">Tìm & gợi ý tập điểm</button>

  <b>Lọc hiệu suất</b>
  <select id="filterEfficiency" onchange="applyFilter()">
    <option value="all">Tất cả</option>
    <option value="0-20">&lt; 20%</option>
    <option value="20-50">20–50%</option>
    <option value="50-80">50–80%</option>
    <option value="80-100">≥ 80%</option>
  </select>

  <button onclick="exportUpgradeList()">
    Danh sách tập điểm cần nâng cấp
  </button>

  <div id="suggestion"></div>

  <div class="legend">
    <b>Chú giải</b>
    <div><span class="color-box" style="background:#2196f3"></span>&lt;20%</div>
    <div><span class="color-box" style="background:#4caf50"></span>20–50%</div>
    <div><span class="color-box" style="background:#ffeb3b"></span>50–80%</div>
    <div><span class="color-box" style="background:#f44336"></span>80–100%</div>
    <div><span class="color-box" style="background:#000"></span>≥100%</div>
  </div>
</div>

<div id="map"></div>

<script>
google.charts.load("current", { packages: ["corechart"] });

const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq/gviz/tq?sheet=Danh%20sách%20tập%20điểm%20S2";

let map = L.map("map").setView([16, 108], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let allPoints = [];
let layerGroup = L.layerGroup().addTo(map);
let highlightLayer = L.layerGroup().addTo(map);

function efficiencyColor(e) {
  if (e >= 100) return "#000";
  if (e >= 80) return "#f44336";
  if (e >= 50) return "#ffeb3b";
  if (e >= 20) return "#4caf50";
  return "#2196f3";
}

function loadData() {
  const query = new google.visualization.Query(SHEET_URL);
  query.send(res => {
    const table = res.getDataTable();
    for (let i = 0; i < table.getNumberOfRows(); i++) {
      const lat = table.getValue(i, 9);
      const lng = table.getValue(i, 10);
      if (!lat || !lng) continue;

      const eff = table.getValue(i, 7) * 100;

      allPoints.push({
        name: table.getValue(i, 2),
        max: table.getValue(i, 3),
        used: table.getValue(i, 4),
        free: table.getValue(i, 5),
        eff,
        lat,
        lng
      });
    }
    renderPoints(allPoints);
  });
}

function renderPoints(points) {
  layerGroup.clearLayers();
  let bounds = [];
  points.forEach(p => {
    const c = L.circle([p.lat, p.lng], {
      radius: 300,
      color: efficiencyColor(p.eff),
      fillOpacity: 0.5
    }).bindPopup(`
      <b>${p.name}</b><br/>
      Dung lượng: ${p.max}<br/>
      Đã dùng: ${p.used}<br/>
      Còn lại: ${p.free}<br/>
      Hiệu suất: ${p.eff.toFixed(1)}%
    `);
    c.addTo(layerGroup);
    bounds.push([p.lat, p.lng]);
  });
  if (bounds.length) map.fitBounds(bounds);
}

function applyFilter() {
  const v = document.getElementById("filterEfficiency").value;
  if (v === "all") return renderPoints(allPoints);

  const [min, max] = v.split("-").map(Number);
  const filtered = allPoints.filter(p =>
    max ? p.eff >= min && p.eff < max : p.eff >= min
  );
  renderPoints(filtered);
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function searchLocation() {
  highlightLayer.clearLayers();
  document.getElementById("suggestion").innerHTML = "";

  const q = document.getElementById("searchInput").value.trim();
  if (!q) return;

  if (q.includes(",")) {
    const [lat, lng] = q.split(",").map(Number);
    handleCustomer(lat, lng);
  } else {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
      .then(r => r.json())
      .then(d => {
        if (d.length) handleCustomer(+d[0].lat, +d[0].lon);
      });
  }
}

function handleCustomer(lat, lng) {
  map.setView([lat, lng], 16);
  L.marker([lat, lng]).addTo(highlightLayer)
    .bindPopup("Vị trí khách hàng").openPopup();

  const candidates = allPoints
    .filter(p => p.free > 0)
    .map(p => ({
      ...p,
      dist: haversine(lat, lng, p.lat, p.lng)
    }))
    .sort((a,b) => a.dist - b.dist)
    .slice(0, 3);

  let html = "<b>Gợi ý tập điểm</b><br/>";
  candidates.forEach((p,i) => {
    L.polyline([[lat,lng],[p.lat,p.lng]], { dashArray: "5,5" })
      .addTo(highlightLayer);
    html += `${i===0?"<span class='best'>":""}
      ${p.name}: ${p.dist.toFixed(0)} m
      ${i===0?"</span>":""}<br/>`;
  });
  document.getElementById("suggestion").innerHTML = html;
}

function exportUpgradeList() {
  const rows = allPoints
    .filter(p => p.eff >= 80)
    .map(p => ({
      "Tên tập điểm": p.name,
      "Latitude": p.lat,
      "Longitude": p.lng,
      "Hiệu suất (%)": p.eff.toFixed(1),
      "Mức ưu tiên": p.eff >= 100 ? "Ưu tiên 1" : "Ưu tiên 2"
    }));

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Nâng cấp");
  XLSX.writeFile(wb, "tap_diem_can_nang_cap.xlsx");
}

google.charts.setOnLoadCallback(loadData);
</script>

</body>
</html>
