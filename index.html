<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>B·∫£n ƒë·ªì hi·ªáu su·∫•t FTTH GPON</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Control Geocoder (SEARCH) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<style>
html, body, #map {
  height: 100%;
  margin: 0;
}

.legend {
  background: white;
  padding: 8px 10px;
  font-size: 13px;
  line-height: 18px;
}
.legend i {
  width: 14px;
  height: 14px;
  float: left;
  margin-right: 6px;
  opacity: 0.8;
}
</style>
</head>

<body>
<div id="map"></div>

<script>
// =====================
// Kh·ªüi t·∫°o map
// =====================
const map = L.map("map").setView([10.78, 106.68], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

// =====================
// SEARCH ƒë·ªãa ch·ªâ / t·ªça ƒë·ªô KH√ÅCH H√ÄNG (ƒê√É FIX)
// =====================
L.Control.geocoder({
  position: "topleft",
  placeholder: "Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c t·ªça ƒë·ªô (lat,lng)",
  defaultMarkGeocode: false
})
.on("markgeocode", function(e) {
  const c = e.geocode.center;

  L.marker(c)
    .addTo(map)
    .bindPopup("üìç V·ªã tr√≠ kh√°ch h√†ng")
    .openPopup();

  map.setView(c, 16);
})
.addTo(map);

// =====================
// H√†m m√†u theo hi·ªáu su·∫•t
// =====================
function getColor(eff) {
  if (eff >= 100) return "black";
  if (eff > 80) return "red";
  if (eff > 50) return "orange";
  return "green";
}

// =====================
// Legend
// =====================
const legend = L.control({ position: "bottomright" });
legend.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = `
    <b>Hi·ªáu su·∫•t s·ª≠ d·ª•ng</b><br>
    <i style="background:green"></i> &lt; 50%<br>
    <i style="background:orange"></i> 50 ‚Äì 80%<br>
    <i style="background:red"></i> 80 ‚Äì 100%<br>
    <i style="background:black"></i> ‚â• 100%
  `;
  return div;
};
legend.addTo(map);

// =====================
// Google Sheet (GVIZ)
// =====================
const SHEET_ID = "1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq";
const SHEET_NAME = "Danh s√°ch t·∫≠p ƒëi·ªÉm S2";

const sheetURL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` +
  `sheet=${encodeURIComponent(SHEET_NAME)}&tq=select *`;

fetch(sheetURL)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(
      text.substring(
        text.indexOf("{"),
        text.lastIndexOf("}") + 1
      )
    );

    const rows = json.table.rows;

    rows.forEach(r => {
      const name  = r.c[2]?.v;             // C
      const total = r.c[3]?.v;             // D
      const used  = r.c[4]?.v;             // E
      const free  = r.c[5]?.v;             // F
      const eff   = r.c[7]?.v * 100;       // H (Percentage ‚Üí %)
      const lat   = r.c[9]?.v;             // J
      const lng   = r.c[10]?.v;            // K

      if (!lat || !lng) return;

      const color = getColor(eff);

      L.circle([lat, lng], {
        radius: 300,
        color: color,
        fillColor: color,
        fillOpacity: 0.4
      })
      .addTo(map)
      .bindPopup(`
        <b>${name}</b><br>
        Dung l∆∞·ª£ng port: ${total}<br>
        ƒê√£ d√πng: ${used}<br>
        C√≤n l·∫°i: ${free}<br>
        Hi·ªáu su·∫•t: ${eff.toFixed(1)}%
      `);
    });
  })
  .catch(err => {
    console.error(err);
    alert("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu Google Sheet");
  });
</script>
</body>
</html>
