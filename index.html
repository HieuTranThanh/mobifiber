<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Bản đồ Mobifiber – Theo dõi tập điểm FTTH</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Google Visualization -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { width: 100vw; height: 100vh; }

    .panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      width: 300px;
    }

    .panel h3 {
      margin: 0 0 6px 0;
      font-size: 14px;
    }

    .panel input, .panel button, .panel select {
      width: 100%;
      margin-bottom: 6px;
      padding: 6px;
      font-size: 13px;
    }

    .legend {
      margin-top: 8px;
      font-size: 12px;
    }

    .legend div {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .legend span {
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 6px;
    }

    @keyframes pulse {
      0% { r: 300; opacity: 0.9; }
      50% { r: 380; opacity: 0.5; }
      100% { r: 300; opacity: 0.9; }
    }

    .pulse {
      animation: pulse 1.5s infinite;
    }
  </style>
</head>

<body>
<div id="map"></div>

<div class="panel">
  <h3>Nhập vị trí của khách hàng</h3>

  <input id="searchInput" placeholder="Địa chỉ hoặc lat,lng" />
  <button onclick="searchLocation()">Tìm</button>

  <select id="filterSelect" onchange="applyFilter()">
    <option value="all">Tất cả</option>
    <option value="<20">< 20%</option>
    <option value="20-50">20–50%</option>
    <option value="50-80">50–80%</option>
    <option value=">=80">≥ 80%</option>
  </select>

  <button onclick="exportUpgradeList()">Danh sách tập điểm cần nâng cấp</button>

  <div class="legend">
    <div><span style="background:#1e90ff"></span>< 20%</div>
    <div><span style="background:#2ecc71"></span>20–50%</div>
    <div><span style="background:#f1c40f"></span>50–80%</div>
    <div><span style="background:#e74c3c"></span>80–<100%</div>
    <div><span style="background:#000"></span>≥ 100%</div>
  </div>
</div>

<script>
/* ================== MAP INIT ================== */
const map = L.map("map").setView([16, 108], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let allPoints = [];
let circles = [];
let customerMarker = null;
let suggestLayers = [];
let initialFitDone = false;

/* ===== VALIDATE COORDINATE (NEW – REQUIRED FIX) ===== */
function isValidCoordinate(latRaw, lngRaw) {
  if (latRaw === null || latRaw === undefined) return false;
  if (lngRaw === null || lngRaw === undefined) return false;

  if (String(latRaw).trim() === "") return false;
  if (String(lngRaw).trim() === "") return false;

  const lat = Number(latRaw);
  const lng = Number(lngRaw);

  if (!Number.isFinite(lat) || !Number.isFinite(lng)) return false;
  if (lat < -90 || lat > 90) return false;
  if (lng < -180 || lng > 180) return false;

  return true;
}

/* ================== LOAD DATA ================== */
google.charts.load("current", { packages:["corechart"] });
google.charts.setOnLoadCallback(loadData);

function loadData() {
  const url =
    "https://docs.google.com/spreadsheets/d/1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq/gviz/tq?sheet=Danh sách tập điểm S2";

  const query = new google.visualization.Query(url);
  query.send(res => {
    const data = res.getDataTable();
    const rows = data.getNumberOfRows();

    for (let i = 0; i < rows; i++) {
      const latRaw = data.getValue(i, 9);
      const lngRaw = data.getValue(i,10);

      // === CHỈ BỔ SUNG CHECK NÀY ===
      if (!isValidCoordinate(latRaw, lngRaw)) continue;

      const point = {
        name: data.getValue(i, 2),
        max: data.getValue(i, 3),
        used: data.getValue(i, 4),
        remain: data.getValue(i, 5),
        eff: data.getValue(i, 7) * 100,
        lat: Number(latRaw),
        lng: Number(lngRaw)
      };

      allPoints.push(point);
    }

    drawPoints(allPoints);
  });
}

/* ================== DRAW ================== */
function getColor(eff) {
  if (eff < 20) return "#1e90ff";
  if (eff < 50) return "#2ecc71";
  if (eff < 80) return "#f1c40f";
  if (eff < 100) return "#e74c3c";
  return "#000";
}

function drawPoints(points) {
  circles.forEach(c => map.removeLayer(c));
  circles = [];

  const bounds = [];

  points.forEach(p => {
    const c = L.circle([p.lat, p.lng], {
      radius: 300,
      color: getColor(p.eff),
      fillColor: getColor(p.eff),
      fillOpacity: 0.6,
      weight: 1
    }).addTo(map);

    c.bindPopup(
      `<b>${p.name}</b><br>
       Dung lượng: ${p.max}<br>
       Đã dùng: ${p.used}<br>
       Còn lại: ${p.remain}<br>
       Hiệu suất: ${p.eff.toFixed(1)}%`
    );

    c._data = p;
    circles.push(c);
    bounds.push([p.lat, p.lng]);
  });

  if (!initialFitDone && bounds.length) {
    map.fitBounds(bounds, { padding: [30,30] });
    initialFitDone = true;
  }
}

/* ================== FILTER ================== */
function applyFilter() {
  const val = document.getElementById("filterSelect").value;

  const filtered = allPoints.filter(p => {
    if (val === "all") return true;
    if (val === "<20") return p.eff < 20;
    if (val === "20-50") return p.eff >= 20 && p.eff < 50;
    if (val === "50-80") return p.eff >= 50 && p.eff < 80;
    if (val === ">=80") return p.eff >= 80;
  });

  drawPoints(filtered);
}

/* ================== SEARCH & SUGGEST ================== */
function searchLocation() {
  const q = document.getElementById("searchInput").value.trim();
  if (!q) return;

  if (q.includes(",")) {
    const [lat,lng] = q.split(",").map(Number);
    zoomToCustomer(lat,lng);
  } else {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
      .then(r => r.json())
      .then(res => {
        if (res.length) zoomToCustomer(+res[0].lat, +res[0].lon);
      });
  }
}

function zoomToCustomer(lat,lng) {
  if (customerMarker) map.removeLayer(customerMarker);
  customerMarker = L.marker([lat,lng]).addTo(map);
  map.setView([lat,lng], 16);
  suggestNearest(lat,lng);
}

/* ================== SUGGEST NEAREST ================== */
function haversine(a,b,c,d){
  const R=6371000;
  const dLat=(c-a)*Math.PI/180;
  const dLng=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}

function suggestNearest(lat,lng){
  suggestLayers.forEach(l=>map.removeLayer(l));
  suggestLayers=[];

  const list = allPoints
    .filter(p=>p.remain>0)
    .map(p=>({...p, dist:haversine(lat,lng,p.lat,p.lng)}))
    .sort((a,b)=>a.dist-b.dist || a.eff-b.eff)
    .slice(0,3);

  list.forEach((p,i)=>{
    const c = circles.find(x=>x._data===p);
    if (!c) return;

    c.setStyle({weight:4});
    c.getElement().classList.add("pulse");

    const line=L.polyline([[lat,lng],[p.lat,p.lng]],{
      color:"green",dashArray:"5,5"
    }).addTo(map);

    c.bindPopup(
      c.getPopup().getContent() +
      `<br><b>Khoảng cách:</b> ${p.dist.toFixed(0)} m` +
      (i===0 ? "<br><b>⭐ Tập điểm tốt nhất</b>" : "")
    );

    suggestLayers.push(line);
  });
}

/* ================== EXPORT ================== */
function exportUpgradeList(){
  const rows = allPoints
    .filter(p=>p.eff>=80)
    .map(p=>({
      "Tên tập điểm":p.name,
      Latitude:p.lat,
      Longitude:p.lng,
      "Hiệu suất (%)":p.eff.toFixed(1),
      "Ưu tiên":p.eff>=100?"Ưu tiên 1":"Ưu tiên 2"
    }));

  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Upgrade");
  XLSX.writeFile(wb,"tap_diem_can_nang_cap.xlsx");
}
</script>
</body>
</html>
