<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Bản đồ kiểm soát hiệu suất FTTH</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin: 0; font-family: Arial, sans-serif; }
#map { height: 100vh; width: 75%; float: left; }
#panel {
  width: 25%;
  height: 100vh;
  overflow-y: auto;
  padding: 10px;
  box-sizing: border-box;
  border-left: 1px solid #ccc;
}
h3 { margin-top: 10px; }
input, select, button {
  width: 100%;
  margin-bottom: 6px;
  padding: 6px;
}
.legend div { margin-bottom: 4px; }
.color-box {
  display: inline-block;
  width: 14px;
  height: 14px;
  margin-right: 6px;
}
.highlight {
  animation: pulse 1s infinite;
}
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}
</style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <h3>Tìm kiếm</h3>
  <input id="searchInput" placeholder="Nhập địa chỉ hoặc Lat,Long" />
  <button onclick="searchLocation()">Tìm kiếm</button>

  <h3>Lọc theo hiệu suất</h3>
  <select id="filterSelect" onchange="applyFilter()">
    <option value="all">Hiển thị tất cả</option>
    <option value="blue">&lt; 20%</option>
    <option value="green">20% - &lt; 50%</option>
    <option value="yellow">50% - &lt; 80%</option>
    <option value="red">80% - &lt; 100%</option>
    <option value="black">&ge; 100%</option>
  </select>

  <h3>Chú giải</h3>
  <div class="legend">
    <div><span class="color-box" style="background:blue"></span>&lt; 20%</div>
    <div><span class="color-box" style="background:green"></span>20% – &lt; 50%</div>
    <div><span class="color-box" style="background:yellow"></span>50% – &lt; 80%</div>
    <div><span class="color-box" style="background:red"></span>80% – &lt; 100%</div>
    <div><span class="color-box" style="background:black"></span>&ge; 100%</div>
  </div>

  <h3>⚠️ Ưu tiên nâng cấp</h3>
  <b>Ưu tiên 1 (≥100%)</b>
  <ul id="priority1"></ul>
  <b>Ưu tiên 2 (80–&lt;100%)</b>
  <ul id="priority2"></ul>

  <h3>⭐ Gợi ý bán hàng</h3>
  <div id="suggestion"></div>
</div>

<script>
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq/gviz/tq?tqx=out:csv&sheet=Danh%20sách%20tập%20điểm%20S2";

const map = L.map("map").setView([16, 108], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

let circles = [];
let allData = [];

function colorByEfficiency(eff) {
  if (eff < 0.2) return "blue";
  if (eff < 0.5) return "green";
  if (eff < 0.8) return "yellow";
  if (eff < 1) return "red";
  return "black";
}

fetch(SHEET_URL)
  .then(r => r.text())
  .then(csv => {
    const rows = csv.split("\n").slice(1);
    const bounds = [];

    rows.forEach(row => {
      const c = row.split(",");
      const name = c[2];
      const address = c[8];
      const maxPort = Number(c[3]);
      const used = Number(c[4]);
      const remain = Number(c[5]);
      const eff = Number(c[7]);
      const lat = Number(c[9]);
      const lng = Number(c[10]);

      if (!lat || !lng) return;

      const color = colorByEfficiency(eff);

      const circle = L.circle([lat, lng], {
        radius: 300,
        color,
        fillColor: color,
        fillOpacity: 0.4
      }).bindPopup(`
        <b>${name}</b><br/>
        ${address}<br/>
        Tổng port: ${maxPort}<br/>
        Đã dùng: ${used}<br/>
        Còn lại: ${remain}<br/>
        Hiệu suất: ${(eff * 100).toFixed(1)}%
      `).addTo(map);

      circles.push({ circle, eff, lat, lng, remain, name });
      allData.push({ eff, name });

      bounds.push([lat, lng]);
    });

    if (bounds.length) map.fitBounds(bounds);

    updatePriorityLists();
  });

function applyFilter() {
  const f = document.getElementById("filterSelect").value;
  circles.forEach(o => {
    const c = colorByEfficiency(o.eff);
    if (f === "all" || f === c) map.addLayer(o.circle);
    else map.removeLayer(o.circle);
  });
}

function updatePriorityLists() {
  const p1 = document.getElementById("priority1");
  const p2 = document.getElementById("priority2");
  p1.innerHTML = "";
  p2.innerHTML = "";

  allData.forEach(d => {
    if (d.eff >= 1) p1.innerHTML += `<li>${d.name}</li>`;
    else if (d.eff >= 0.8) p2.innerHTML += `<li>${d.name}</li>`;
  });
}

let searchMarker;

function searchLocation() {
  const v = document.getElementById("searchInput").value.trim();
  let lat, lng;

  if (v.includes(",")) {
    [lat, lng] = v.split(",").map(Number);
    goToLocation(lat, lng);
  } else {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${v}`)
      .then(r => r.json())
      .then(d => {
        if (d.length) goToLocation(+d[0].lat, +d[0].lon);
      });
  }
}

function goToLocation(lat, lng) {
  if (searchMarker) map.removeLayer(searchMarker);
  searchMarker = L.marker([lat, lng]).addTo(map);
  map.setView([lat, lng], 16);

  circles.forEach(o => o.circle.setStyle({ weight: 1 }));

  const available = circles
    .filter(o => o.remain > 0)
    .map(o => ({
      ...o,
      dist: map.distance([lat, lng], [o.lat, o.lng])
    }))
    .sort((a, b) => a.dist - b.dist)
    .slice(0, 3);

  available.forEach(o => {
    o.circle.setStyle({ weight: 4 });
    o.circle.getElement().classList.add("highlight");
  });

  if (available.length) {
    const best = available.sort((a, b) =>
      a.dist !== b.dist ? a.dist - b.dist : a.eff - b.eff
    )[0];

    document.getElementById("suggestion").innerHTML =
      `<b>${best.name}</b><br/>Khoảng cách: ${best.dist.toFixed(0)} m`;
  }
}
</script>

</body>
</html>
