<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>B·∫£n ƒë·ªì hi·ªáu su·∫•t FTTH GPON</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
  }
  #map {
    height: 100vh;
    width: 100%;
  }
  .control-panel {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 6px;
    width: 320px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-size: 14px;
  }
  .legend div {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
  }
  .color-box {
    width: 14px;
    height: 14px;
    margin-right: 6px;
  }
  .upgrade-list {
    max-height: 180px;
    overflow-y: auto;
    font-size: 13px;
  }
  .blink {
    animation: blink 1s infinite;
  }
  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.4; }
    100% { opacity: 1; }
  }
</style>
</head>

<body>

<div class="control-panel">
  <b>üîé Nh·∫≠p v·ªã tr√≠ t√¨m ki·∫øm</b><br/>
  <input
    id="searchInput"
    type="text"
    placeholder="ƒê·ªãa ch·ªâ ho·∫∑c Lat,Lng"
    style="width:100%; margin-top:4px"
  />
  <button onclick="searchLocation()" style="width:100%; margin-top:6px">
    T√¨m ki·∫øm
  </button>

  <hr/>
  <b>üéØ L·ªçc theo hi·ªáu su·∫•t</b><br/>
  <select id="filterSelect" onchange="applyFilter()" style="width:100%">
    <option value="all">T·∫•t c·∫£</option>
    <option value="low">< 20%</option>
    <option value="mid1">20% ‚Äì <50%</option>
    <option value="mid2">50% ‚Äì <80%</option>
    <option value="high">80% ‚Äì <100%</option>
    <option value="full">>= 100%</option>
  </select>

  <hr/>
  <b>üé® Ch√∫ th√≠ch</b>
  <div class="legend">
    <div><span class="color-box" style="background:#007bff"></span>< 20%</div>
    <div><span class="color-box" style="background:#28a745"></span>20‚Äì<50%</div>
    <div><span class="color-box" style="background:#ffc107"></span>50‚Äì<80%</div>
    <div><span class="color-box" style="background:#dc3545"></span>80‚Äì<100%</div>
    <div><span class="color-box" style="background:#000"></span>>=100%</div>
  </div>

  <hr/>
  <b>üõ† T·∫≠p ƒëi·ªÉm c·∫ßn n√¢ng c·∫•p</b>
  <div class="upgrade-list" id="upgradeList"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const SHEET_ID = "1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq";
const SHEET_NAME = "Danh s√°ch t·∫≠p ƒëi·ªÉm S2";

const map = L.map("map").setView([16.5, 106], 6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

let circles = [];
let allData = [];
let customerMarker = null;

function getColor(eff) {
  if (eff < 0.2) return "#007bff";
  if (eff < 0.5) return "#28a745";
  if (eff < 0.8) return "#ffc107";
  if (eff < 1) return "#dc3545";
  return "#000";
}

function loadData() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}`;
  fetch(url)
    .then(res => res.text())
    .then(text => {
      const json = JSON.parse(text.substring(47).slice(0, -2));
      json.table.rows.forEach(r => {
        const data = {
          name: r.c[2]?.v,
          maxPort: r.c[3]?.v,
          usedPort: r.c[4]?.v,
          remainPort: r.c[5]?.v,
          efficiency: r.c[7]?.v,
          address: r.c[8]?.v,
          lat: r.c[9]?.v,
          lng: r.c[10]?.v
        };
        if (data.lat && data.lng) {
          allData.push(data);
        }
      });
      drawPoints();
      listUpgrade();
    });
}

function drawPoints() {
  let bounds = [];
  allData.forEach(d => {
    const circle = L.circle([d.lat, d.lng], {
      radius: 300,
      color: getColor(d.efficiency),
      fillColor: getColor(d.efficiency),
      fillOpacity: 0.5,
      weight: 1
    }).addTo(map);

    circle.data = d;
    circles.push(circle);
    bounds.push([d.lat, d.lng]);

    circle.bindPopup(`
      <b>${d.name}</b><br/>
      ${d.address}<br/>
      <hr/>
      T·ªïng port: ${d.maxPort}<br/>
      ƒê√£ d√πng: ${d.usedPort}<br/>
      C√≤n l·∫°i: ${d.remainPort}<br/>
      Hi·ªáu su·∫•t: ${(d.efficiency * 100).toFixed(1)}%
    `);
  });
  map.fitBounds(bounds);
}

function applyFilter() {
  const f = document.getElementById("filterSelect").value;
  circles.forEach(c => {
    const e = c.data.efficiency;
    let show = true;
    if (f === "low") show = e < 0.2;
    if (f === "mid1") show = e >= 0.2 && e < 0.5;
    if (f === "mid2") show = e >= 0.5 && e < 0.8;
    if (f === "high") show = e >= 0.8 && e < 1;
    if (f === "full") show = e >= 1;
    if (show) c.addTo(map); else map.removeLayer(c);
  });
}

function searchLocation() {
  const val = document.getElementById("searchInput").value.trim();
  if (!val) return;

  if (customerMarker) map.removeLayer(customerMarker);

  if (val.includes(",")) {
    const [lat, lng] = val.split(",").map(Number);
    locateCustomer(lat, lng);
  } else {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`)
      .then(r => r.json())
      .then(res => {
        if (res.length) locateCustomer(res[0].lat, res[0].lon);
      });
  }
}

function locateCustomer(lat, lng) {
  customerMarker = L.marker([lat, lng]).addTo(map).bindPopup("üìç V·ªã tr√≠ kh√°ch h√†ng").openPopup();
  map.setView([lat, lng], 16);

  const nearest = circles
    .map(c => ({
      circle: c,
      d: map.distance([lat, lng], c.getLatLng())
    }))
    .sort((a, b) => a.d - b.d)
    .slice(0, 3);

  nearest.forEach(n => {
    n.circle.setStyle({ weight: 4 });
    n.circle.getElement().classList.add("blink");
    const status = n.circle.data.remainPort > 0 ? "‚úÖ C√≥ th·ªÉ b√°n" : "‚ùå T·∫≠p ƒëi·ªÉm ƒë√£ full port";
    n.circle.bindPopup(
      n.circle.getPopup().getContent() +
      `<hr/>Kho·∫£ng c√°ch: ${Math.round(n.d)} m<br/><b>${status}</b>`
    );
  });
}

function listUpgrade() {
  const div = document.getElementById("upgradeList");
  const p1 = allData.filter(d => d.efficiency >= 1);
  const p2 = allData.filter(d => d.efficiency >= 0.8 && d.efficiency < 1);

  div.innerHTML = `
    <b>∆Øu ti√™n 1 (>=100%)</b><br/>
    ${p1.map(d => `‚Ä¢ ${d.name}`).join("<br/>")}
    <hr/>
    <b>∆Øu ti√™n 2 (80‚Äì<100%)</b><br/>
    ${p2.map(d => `‚Ä¢ ${d.name}`).join("<br/>")}
  `;
}

loadData();
</script>

</body>
</html>
