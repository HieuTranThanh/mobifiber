<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Bản đồ FTTH – Blink chuẩn</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
html, body { height:100%; margin:0; font-family:Arial }
#map { height:100% }

.control {
  position:absolute; top:10px; left:10px; z-index:1000;
  background:#fff; padding:10px; width:260px;
  border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,.3)
}

.control input, button, select {
  width:100%; margin-bottom:6px; padding:6px
}

/* ===== BLINK ===== */
.blink {
  animation: blinkStroke 1.2s infinite;
}

.blink-fast {
  animation: blinkStroke 0.6s infinite;
}

@keyframes blinkStroke {
  0% { stroke-opacity:1; }
  50% { stroke-opacity:0; }
  100% { stroke-opacity:1; }
}
</style>
</head>

<body>

<div class="control">
  <input id="searchInput" placeholder="Địa chỉ hoặc lat,lng">
  <button onclick="searchLocation()">Tìm khách hàng</button>
</div>

<div id="map"></div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq";
const SHEET_NAME = "Danh sách tập điểm S2";

let map;
let circles = [];
let lines = [];
let customerMarker;

/* ================= INIT ================= */
google.charts.load("current", { packages:["corechart"] });
google.charts.setOnLoadCallback(init);

function init() {
  map = L.map("map").setView([16,108],6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  loadData();
}

/* ================= LOAD DATA ================= */
function loadData() {
  const q = new google.visualization.Query(
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}`
  );

  q.send(res => {
    const t = res.getDataTable();
    for (let i = 0; i < t.getNumberOfRows(); i++) {
      const lat = +t.getValue(i,9);
      const lng = +t.getValue(i,10);
      if (isNaN(lat) || isNaN(lng)) continue;

      const rate = t.getValue(i,7) * 100;
      const circle = L.circle([lat,lng], {
        radius:300,
        color:"#555",
        weight:2,
        fillOpacity:0.5
      }).addTo(map);

      circles.push({
        name: t.getValue(i,2),
        lat, lng,
        free: t.getValue(i,5),
        rate,
        circle
      });
    }

    map.fitBounds(L.featureGroup(circles.map(c=>c.circle)).getBounds());
  });
}

/* ================= SEARCH (THEO ĐÚNG CODE BẠN ĐƯA) ================= */
function searchLocation() {
  clearSuggest();

  const q = document.getElementById("searchInput").value.trim();
  if (!q) return;

  if (q.includes(",")) {
    const [lat, lng] = q.split(",").map(Number);
    focusLocation(lat, lng);
  } else {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`)
      .then(r => r.json())
      .then(d => {
        if (d.length > 0) {
          focusLocation(+d[0].lat, +d[0].lon);
        }
      });
  }
}

function focusLocation(lat, lng) {
  map.setView([lat, lng], 15);

  customerMarker = L.marker([lat, lng])
    .addTo(map)
    .bindPopup("Vị trí khách hàng")
    .openPopup();

  const candidates = circles
    .filter(c => c.free > 0)
    .map(c => ({
      ...c,
      dist: map.distance([lat, lng], [c.lat, c.lng])
    }))
    .sort((a, b) => a.dist - b.dist || a.rate - b.rate)
    .slice(0, 3);

  candidates.forEach((c, idx) => {
    c.circle.setStyle({
      weight: idx === 0 ? 5 : 4,
      color: idx === 0 ? "#000" : "#555"
    });

    const el = c.circle.getElement();
    if (el) {
      el.classList.add(idx === 0 ? "blink-fast" : "blink");
    }

    const line = L.polyline([[lat,lng],[c.lat,c.lng]], {
      dashArray:"6,6",
      color:"#000"
    }).addTo(map);

    c.circle.bindTooltip(`${Math.round(c.dist)} m`).openTooltip();
    lines.push(line);
  });
}

/* ================= CLEAR ================= */
function clearSuggest() {
  lines.forEach(l => map.removeLayer(l));
  lines = [];

  circles.forEach(c => {
    const el = c.circle.getElement();
    if (el) el.classList.remove("blink","blink-fast");
    c.circle.closeTooltip();
  });

  if (customerMarker) {
    map.removeLayer(customerMarker);
    customerMarker = null;
  }
}
</script>

</body>
</html>
