<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Bản đồ hiệu suất FTTH GPON</title>

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Google Visualization -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: Arial, sans-serif;
}

#map {
  height: 100%;
}

.control-panel {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 1000;
  background: white;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  width: 280px;
}

.control-panel h3 {
  margin: 0 0 8px 0;
  font-size: 14px;
}

.control-panel input,
.control-panel select,
.control-panel button {
  width: 100%;
  margin-bottom: 6px;
  padding: 6px;
}

.legend {
  margin-top: 8px;
  font-size: 12px;
}

.legend div {
  display: flex;
  align-items: center;
  margin-bottom: 4px;
}

.legend span {
  width: 14px;
  height: 14px;
  display: inline-block;
  margin-right: 6px;
  border: 1px solid #333;
}

.pulse {
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.15); }
  100% { transform: scale(1); }
}
</style>
</head>

<body>

<div class="control-panel">
  <h3>FTTH – Hiệu suất port</h3>

  <input id="searchInput" placeholder="Địa chỉ hoặc lat,lng" />
  <button onclick="searchLocation()">Tìm khách hàng</button>

  <select id="filterSelect" onchange="applyFilter()">
    <option value="all">Tất cả</option>
    <option value="lt20">&lt; 20%</option>
    <option value="20to50">20 – 50%</option>
    <option value="50to80">50 – 80%</option>
    <option value="gte80">&ge; 80%</option>
  </select>

  <button onclick="exportUpgradeList()">
    Danh sách tập điểm cần nâng cấp
  </button>

  <div class="legend">
    <strong>Legend</strong>
    <div><span style="background:#1e90ff"></span>&lt; 20%</div>
    <div><span style="background:#2ecc71"></span>20 – 50%</div>
    <div><span style="background:#f1c40f"></span>50 – 80%</div>
    <div><span style="background:#e74c3c"></span>80 – &lt;100%</div>
    <div><span style="background:#000"></span>&ge; 100%</div>
  </div>
</div>

<div id="map"></div>

<script>
/* ====================== CẤU HÌNH ====================== */
const SHEET_ID = "1avvicsQgJIm_D66EsPxFE7aUBCfuMdBq";
const SHEET_NAME = "Danh sách tập điểm S2";

/* ====================== BIẾN TOÀN CỤC ====================== */
let map;
let allPoints = [];
let circleLayers = [];
let suggestionLayers = [];

/* ====================== KHỞI TẠO ====================== */
google.charts.load("current", { packages: ["corechart"] });
google.charts.setOnLoadCallback(init);

function init() {
  initMap();
  loadData();
}

/* ====================== MAP ====================== */
function initMap() {
  map = L.map("map").setView([16, 108], 6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);
}

/* ====================== LOAD DATA ====================== */
function loadData() {
  const query = new google.visualization.Query(
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}`
  );

  query.send(response => {
    if (response.isError()) {
      alert("Lỗi load Google Sheet");
      return;
    }

    const table = response.getDataTable();
    const rows = table.getNumberOfRows();

    for (let i = 0; i < rows; i++) {
      const lat = table.getValue(i, 9);
      const lng = table.getValue(i, 10);

      if (!isValidCoordinate(lat, lng)) continue;

      allPoints.push({
        name: table.getValue(i, 2),
        maxPort: table.getValue(i, 3),
        usedPort: table.getValue(i, 4),
        freePort: table.getValue(i, 5),
        utilization: table.getValue(i, 7) * 100,
        lat: Number(lat),
        lng: Number(lng)
      });
    }

    drawPoints(allPoints);
    autoFit();
  });
}

/* ====================== VALIDATE ====================== */
function isValidCoordinate(lat, lng) {
  if (lat === null || lng === null) return false;
  lat = Number(lat);
  lng = Number(lng);
  if (isNaN(lat) || isNaN(lng)) return false;
  if (lat < -90 || lat > 90) return false;
  if (lng < -180 || lng > 180) return false;
  return true;
}

/* ====================== MÀU ====================== */
function getColor(util) {
  if (util < 20) return "#1e90ff";
  if (util < 50) return "#2ecc71";
  if (util < 80) return "#f1c40f";
  if (util < 100) return "#e74c3c";
  return "#000000";
}

/* ====================== VẼ ====================== */
function drawPoints(points) {
  circleLayers.forEach(c => map.removeLayer(c));
  circleLayers = [];

  points.forEach(p => {
    const circle = L.circle([p.lat, p.lng], {
      radius: 300,
      color: getColor(p.utilization),
      fillColor: getColor(p.utilization),
      fillOpacity: 0.6
    }).addTo(map);

    circle.bindPopup(`
      <strong>${p.name}</strong><br/>
      Port tối đa: ${p.maxPort}<br/>
      Đã dùng: ${p.usedPort}<br/>
      Còn lại: ${p.freePort}<br/>
      Hiệu suất: ${p.utilization.toFixed(1)}%
    `);

    circle._data = p;
    circleLayers.push(circle);
  });
}

/* ====================== FIT ====================== */
function autoFit() {
  if (circleLayers.length === 0) return;
  const group = L.featureGroup(circleLayers);
  map.fitBounds(group.getBounds().pad(0.2));
}

/* ====================== FILTER ====================== */
function applyFilter() {
  const val = document.getElementById("filterSelect").value;
  let filtered = allPoints;

  if (val === "lt20") filtered = allPoints.filter(p => p.utilization < 20);
  if (val === "20to50") filtered = allPoints.filter(p => p.utilization >= 20 && p.utilization < 50);
  if (val === "50to80") filtered = allPoints.filter(p => p.utilization >= 50 && p.utilization < 80);
  if (val === "gte80") filtered = allPoints.filter(p => p.utilization >= 80);

  drawPoints(filtered);
}

/* ====================== SEARCH ====================== */
async function searchLocation() {
  const val = document.getElementById("searchInput").value.trim();
  if (!val) return;

  let lat, lng;

  if (val.includes(",")) {
    const parts = val.split(",");
    lat = Number(parts[0]);
    lng = Number(parts[1]);
  } else {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}`
    );
    const data = await res.json();
    if (!data.length) return;
    lat = Number(data[0].lat);
    lng = Number(data[0].lon);
  }

  map.setView([lat, lng], 16);
  suggestPoints(lat, lng);
}

/* ====================== GỢI Ý ====================== */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function suggestPoints(lat, lng) {
  suggestionLayers.forEach(l => map.removeLayer(l));
  suggestionLayers = [];

  const candidates = allPoints
    .filter(p => p.freePort > 0)
    .map(p => ({
      ...p,
      distance: haversine(lat, lng, p.lat, p.lng)
    }))
    .sort((a, b) =>
      a.distance - b.distance ||
      b.freePort - a.freePort ||
      a.utilization - b.utilization
    )
    .slice(0, 3);

  candidates.forEach((p, idx) => {
    const c = L.circle([p.lat, p.lng], {
      radius: 450,
      color: idx === 0 ? "#000" : "#555",
      fillOpacity: 0.4,
      className: "pulse"
    }).addTo(map);

    c.bindPopup(`
      <strong>${p.name}</strong><br/>
      Khoảng cách: ${p.distance.toFixed(0)} m<br/>
      Hiệu suất: ${p.utilization.toFixed(1)}%
    `);

    suggestionLayers.push(c);
  });
}

/* ====================== EXPORT ====================== */
function exportUpgradeList() {
  const data = allPoints
    .filter(p => p.utilization >= 80)
    .map(p => ({
      "Tên tập điểm": p.name,
      "Latitude": p.lat,
      "Longitude": p.lng,
      "Hiệu suất (%)": p.utilization.toFixed(1),
      "Mức ưu tiên": p.utilization >= 100 ? "Ưu tiên 1" : "Ưu tiên 2"
    }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Upgrade");

  XLSX.writeFile(wb, "tap_diem_can_nang_cap.csv");
}
</script>

</body>
</html>
